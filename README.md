# مدیریت ورود و خروج بر بستر اینترنت اشیا

### شرح پروژه:

در این پروژه قصد داریم تا سامانه ای جهت کنترل لحظه ای ورود و خروج افراد به یک شرکت فرضی را بر بستر اینترنت اشیا پیاده سازی کنیم. چنین سامانه ای متشکل تشکل از بخشهای زیر خواهد بود:
<br/><br/>
- سامانه نهفته شامل سنسورها و ماژولهای سخت افزاری

- ابر (cloud) که در این تمرین یک وب سرور ساده در نظر گرفته میشود

- سیستم نظارتی (نرم افزاری جهت مشاهده رویدادهای سامانه به شکل لحظه ای)
<br/><br/>
در ادامه، توضیحات، کدها و گزارشات مربوط به هرکدام از بخش ها آورده خواهد شد. 
<br/><br/>
## بخش اول: سامانه نهفته نصب شده در محل 
توضیحات بخش: 
<br/><br/>
جهت شناسایی کارمندان از سنسور و تک RFID استفاده میشود. هر RFID tag برابر با هویت یک فرد است. در ورودی شرکت یک RFID sensor قرار دارد که با استفاده از آن میتوان مشخصات افراد را از روی RFID tag خواند. این مشخصه یک کد 10 رقمی است. 
<br/><br/>
باز و بسته شدن در شرکت به وسیله یک motor servo کنترل میشود. همچنین مقابل در، یک چراغ LED و یک مانیتور وجود دارد. LED با 
توجه به اجازه ورود به دو رنگ قرمز یا سبز در میآید، در همین هنگام مشخصات فرد بر روی مانیتور نمایش داده میشود. 
<br/><br/>
برای ارتباط با شبکه ی اینترنت و ارسال داده نیاز به یک سخت افزار جهت ارسال و دریافت داده به صورت بی سیم داریم که این کار با ماژول ESP8266 wifi انجام میشود. 
<br/><br/>
در نهایت کنترل تمامی این ماژولها بهوسیله یک برد Arduino انجام میشود
<br/><br/>
### بخش اول: خواندن RFID و ارسال برای سرور 
![image (9)](https://github.com/FaSha20/EntranceManagement/assets/114980788/729d6fb1-c6c3-4229-9249-15a4d9c4c5b8)
<br/><br/>
همانطور که در تصویر بالا مشاهده میکنیم، این بخش از یک ماژول آردوینو، یک ماژول اترنت برای ارسال پکتها و ارتباط با سرور، و یک ترمینال مجازی برای شبیه سازی دریافت RFID ها، و دو لامپ قرمز و سبز داریم.
<br/><br/>
![image (7)](https://github.com/FaSha20/EntranceManagement/assets/114980788/8ad16fbf-eba3-4b4c-adee-5300a5ef53a4)
<br/><br/>
در اینجا میبینیم که کد داده شده به برد آردوینو کامپایل شده و درحال گرفتن ورودی است. 
<br/><br/>
![image](https://github.com/FaSha20/EntranceManagement/assets/114980788/6f707b9b-a74d-4fdd-827c-f11df87e10a7)
<br/><br/>
پس از اینکه در ترمینال ورودی را وارد کردیم، در اینجا نتیجه را مشاهده میکنیم. اگر به آدرس 192.168.2.2 ریکوئست GET زده شود، به ما پکتی برمی گرداند که در خود محتوای RFID خوانده شده را دارد. در عکس بعدی هدر پکت را میبینیم و مشاهده میکنیم که آیدی داده شده ارسال شده است. 
<br/><br/>
![image (2)](https://github.com/FaSha20/EntranceManagement/assets/114980788/ab8892b5-5ba1-4973-b6b4-60af3406bb99)
<br/><br/>
در ادامه به توضیح کد این بخش میپردازیم:
<br/><br/>
![image (3)](https://github.com/FaSha20/EntranceManagement/assets/114980788/bd70f41e-6b30-4757-92ca-7048fde8acd5)
<br/><br/>
از کتابخانه Ethercard استفاده میکنیم. مقادیر constant، آدرس مک، myip (آی پی که ما با آن شناخته میشویم)، gwip (آی پی اترنت که از طریق آن، ماژول اترنت با سرور ارتباط میگیرد

<br/><br/>
![image (4)](https://github.com/FaSha20/EntranceManagement/assets/114980788/be564b5f-3a97-4c28-b0ef-9d1aab139e8d)
<br/><br/>
در اینجا تابع sendHTTpResponse را داریم که بدنه ریسپانس را میسازد و آیدی گرفته شده در ورودی را به عنوان هدر Authentication قرار میدهد و با تابع ether.httpServerReply آن را ارسال میکند.
<br/><br/>
![image (5)](https://github.com/FaSha20/EntranceManagement/assets/114980788/2e31c94f-e77e-468b-9160-e3204c004c9f)
<br/><br/>
در اینجا تابع خواندن RFID از ترمینال را داریم که تا وقتی ورودی دارد و میخواند، به رشته ورودی اضافه میکند و به char تبدیل میکند و برمیگرداند. 
<br/><br/>
![image (10)](https://github.com/FaSha20/EntranceManagement/assets/114980788/e045d089-6156-44dc-bc6b-9945ca050625)
<br/><br/>
تابع setup را داریم که مقادیر اولیه را روی برد ست میکند. ست کردن پورت های مربوط به LED، چک کردن سایز بافر اترنت که به اندازه کافی باشد، ست کردن آی پی ها روی اترنت و... . این تابع یک بار و در ابتدا اجرا میشود. 
<br/><br/>
![image (6)](https://github.com/FaSha20/EntranceManagement/assets/114980788/c59c20f0-f190-4137-9762-d4cccfe80ecb)
<br/><br/>
تابع loop، تابعی است که مدام در طور برنامه اجرا میشود تا اگر درخواستی وجود دارد، با فراخوانی تابع مربوطه، بخواند و اگر بسته ای رسیده بود، آن را ارسال کند. 
<br/><br/>

### بخش دوم: انجام عملیاتهای مربوطه پس از دریافت نتیجه از سرور
در اینجا ابتدا شکل اتصالات و ماژولهای مربوط به بخش دوم را مشاهده میکنیم. مشابه قسمت قبل، ماژول برد آردوینو و ماژول اترنت را داریم. همچنین دو ماژول LED برای دو چراغ قرمز و سبز، و یک موتور به همراه ماژول کنترلی آن برای باز و بسته کردن درب. 
<br/><br/>
![image (11)](https://github.com/FaSha20/EntranceManagement/assets/114980788/669909bd-11c9-4bc1-9fd6-62343b59561f)
<br/><br/>
ابتدا عملکرد کد را میبینیم و سپس به بررسی کد و توابع آن میپردازیم. در تصاویر زیر به ترتیب عملکرد این بخش قابل مشاهده است. مشاهده میکنیم که با ورود دستورات و ارسال آن، تغییر رنگ LED متناسب با موثعیت اتفاق میفتد و موتور نیز 90 درجه به حرکت در می آید. 
<br/><br/>
![Screenshot 2024-05-03 184624](https://github.com/FaSha20/EntranceManagement/assets/114980788/7319cb1f-8bd6-4795-b497-129b3c6eb94f)
<br/><br/>
![Screenshot 2024-05-03 184707](https://github.com/FaSha20/EntranceManagement/assets/114980788/e1b56071-d859-4169-a14c-a60645e2edbd)
<br/><br/>
![Screenshot 2024-05-03 184802](https://github.com/FaSha20/EntranceManagement/assets/114980788/d9f1ce97-ef43-4cba-bdf4-d741dff7ec15)
<br/><br/>

حال کدهای مربوط به این بخش را بررسی میکنیم.
<br/><br/>
![image (12)](https://github.com/FaSha20/EntranceManagement/assets/114980788/19b09336-52aa-4fb0-bbbb-56e69ebbbb15)
<br/><br/>
تابع DoEntryActions زمانی که برایش پیغام آمده باشد که آیدی ارسالی valid است، چراغ سبز را روشن میکند، DC motor را فعال میکند. delay برای این است که موتور 90 درجه بچرخد. بعد حرکت موتور را ثابت میکند، وضعیت فلگ در را به حالت باز ست میکند و ساعت فعلی را در start time ذخیره میکند. اما در هنوز باز است. در صورت پروژه چنان داریم که در بازه ای که در هنوز باز است تا فرد عبور کند، اگر فرد invalid ای وارد شد، در باید فورا بسته شود و چراغ قرمز روشن شود. اگر هم کسی نیاید، بعد از 30 ثانیه در باید خود به خود بسته شود. فلذا نگه میداریم که از کی در را باز گذاشته ایم. 
<br/><br/>
![image (13)](https://github.com/FaSha20/EntranceManagement/assets/114980788/e897f0f7-ef08-4038-9190-451087b04962)
<br/><br/>
تابع بعدی DoPreventiveActions است برای جلوگیری از همان شرایطی که در قسمت قبل توضیح داده شد. اگر در باز بوده، در را میبندد، چراغ قرمز را روشن میکند و پس از 500 واحد زمانی، خاموش میکند. 
تابع closeTheDoor هم همان عکس عملیات باز کردن DC motor را انجام میدهد. و نهایتا فلگ isOpen را صفر میکند. 
<br/><br/>
![image (14)](https://github.com/FaSha20/EntranceManagement/assets/114980788/1f746ae6-d0d8-4ba0-83cd-1437152104ae)
<br/><br/>
تابع setup نیز مشابه آنچه در بخش قبل داشتیم، پینها، مقادیر اولیه و اترنت را ست میکند.
<br/><br/>
![image (14)](https://github.com/FaSha20/EntranceManagement/assets/114980788/f0db0ddd-d5c9-403e-993b-45ce0f9b29bf)
<br/><br/>
تابع loop ابتدا زمان فعلی را میگیرد و چک میکند که آیا در باز است یا خیر، اگر باز بود و از زمان باز بودنش بیش از 5 ثانیه گذشته است، در را میبندد. در ادامه، بررسی میکند که آیا پکتی برایش آمده است یا خیر. این پکت همان ریپلای سرور است که قرار است valid یا invalid بودن آیدی ارسالی شده را تایید کند. نگاه میکند اگر در ورودی که برایش آمده، 200 هست، (valid) فرد را راه بده. و اگر نیست، یعنی invald است، پس عملیات های مربوط به این بخش را انجام بده. 
<br/><br/>
![image (15)](https://github.com/FaSha20/EntranceManagement/assets/114980788/6eb6ebeb-2f6a-4b4b-824f-6315bb720f5c)
<br/><br/>
<br/><br/>

## بخش دوم: ابر (cloud) 
این بخش متشکل است از یک وب سرور که شامل لیستی از افراد مجاز است. تمامی افراد خارج از این لیست ورودشان به شرکت غیر مجاز است. وب سرور و برد آردوینو از طریق پروتکل HTTP با یکدیگر ارتباط برقرار میکنند. کدهای مربوط به این بخش در ادامه آورده خواهند شد. 
<br/><br/>
کد این بخش به صورت objective طراحی شده است. همانطور که در قطعه کد پایین میبینیم، یک main داریم که core application در آن ساخته میشود، یک instance از object وب اپلیکیشن به نام webApp میسازیم و تابع startServer آن را فراخوانی میکنیم. 
<br/><br/>
![1](https://github.com/FaSha20/EntranceManagement/assets/114980788/f458224e-d559-465b-8f36-d1d58b0de755)
<br/><br/>
در این ساختار ما سه هدر داریم. http server، web socket و web application. در main ابتدا web application را میسازیم و در constructor وب اپلیکیشن، یک نسخه از http server و یک نسخه web socket و پورتی که قرار است سوکت رویش گوش کند. 
کلاس web application یک تابع start server دارد که http server را بالا می اورد. وب سوکت هم در constructor وب اپلیکیشن ساخته میشود و با پورتی که برای آن مشخص کرده ایم (8083) و true (که یعنی مشغول گوش دادن باش) اجرا میشود. 
<br/><br/>
![2](https://github.com/FaSha20/EntranceManagement/assets/114980788/5594d908-6f37-4f79-9669-aace776a5951)
<br/><br/>
![3](https://github.com/FaSha20/EntranceManagement/assets/114980788/78ba6746-5b70-4ad6-8bb9-57248f29f113)
<br/><br/>
در هدر http server یک QhttpServer و دو پورت تگه داری میکنیم. تابع start server، ابتدا ro,t ها را تعریف میکند و تابع setupRout را صدا میزند. rout در واقع یک هدر authentication و در ادامه 3 تا RFID که در این مثال 3 شماره دانشجویی قرار داده شده است، اگر ورودی با این سه شماره دانشجویی برابر بود، ریسپانس ok میدهد و در غیر این صورت، ریسپانس invalid میدهد. پس از ست کردن rout، به http server دستور listen میدهد. و سرور روی لوکال هاست و پورتی که به آن داده شده بود، مشغول گوش دادن میشود. سپس setupSSL را صدا میزنیم. این تابع پیکربندی مربوط به SSL را انجام میدهد. 
<br/><br/>
![4](https://github.com/FaSha20/EntranceManagement/assets/114980788/f0ff8e95-2568-498f-b13d-61ac9709cede)
<br/><br/>
![5](https://github.com/FaSha20/EntranceManagement/assets/114980788/9f07ac39-b217-43dd-a8fd-01a833508d9a)
<br/><br/>
![6](https://github.com/FaSha20/EntranceManagement/assets/114980788/2d56f201-d79d-4a91-958b-7c224e65b24e)
<br/><br/>
![7](https://github.com/FaSha20/EntranceManagement/assets/114980788/3ae78003-0afb-4b16-a3af-2b2967a562dc)
<br/><br/>
سپس به توضیحات مربوط به وب سوکت میرسیم. وب سوکت ارتباط میان سرور و gui را برقرار میکند. که سه تابع onNewConnection، processTextMesseges و socketDisconnected را داراست. همچنین سرور اصلی وب سوکت و لیست کلاینتهای ما را نگه داری میکند. همچنین یک وکتور users هم نگه داری میکند که userهایی که از سمت gui میرسند را به صورت رشته ذخیره میکند. 

<br/><br/>
![8](https://github.com/FaSha20/EntranceManagement/assets/114980788/0e87b66e-7d97-4f04-90ac-46511093d443)
<br/><br/>
در constructor وب سوکت، پورت و لوکال هاست مدنظر را ست میکنیم و روی این پورت مشغول گوش دادن میشود. هر زمان که یک connection جدید درخواست شود، تابع onNewConnection صدا زده میشود. و هر وقت اتصال قطع شود، وب سوکت بسته شود. 
<br/><br/>
در تابع onNewConnection، کلاینت را در psocket ذخیره میکند و کلاینت را وصل میکند. که شامل 2 تابع connect است. یکی textMessegeRecieved که به processTexMessege وصل میکند، یعنی هرزمان که پیام جدیدی از سمت این کلاینت دریافت کند، تابع processTextMessege را قراخوانی میکند. در تابع processTextMessege، ابتدا پیامی که از کلاینت گرفته شده را توکنایز میکند، کلاینت را (یوزر و پسورد) validate میکند. اگر با این سه تایی که در لیست داده شده، یکسان بود، قبول میکند، وکتور را آپدیت میکند و پیامی را برای کاربر ارسال میکند. و اگر پیام دریافتی $ بود، (که قراردادی بین وب سوکت و gui است) یعنی کلاینت همه یوزرها را میخواهد. پس تمام یوزرها را جوین میکند و و ارسال میکند. در غیر این صورت، یک پیام خالی ارسال میکند که gui متوجه میشود که درخواست ارسالی valid نبوده است. 

<br/><br/>
![9](https://github.com/FaSha20/EntranceManagement/assets/114980788/220d82b9-9d1d-44ff-acc2-abcb50d5d61e)
<br/><br/>
![10](https://github.com/FaSha20/EntranceManagement/assets/114980788/80ee9f83-12fa-4121-a6d2-efa6cde79476)
<br/><br/>


